---
import Layout from '../../layouts/Layout.astro';
import ProductGrid from '../../components/ProductGrid.astro';
import { getCollection } from 'astro:content';
import { slugify } from '../../utils/common';

export async function getStaticPaths() {
  const products = await getCollection('products');
  
  // 1. Product Paths
  const productPaths = products.map(product => ({
    params: { slug: product.slug },
    props: { type: 'product' as const, product },
  }));

  // 2. Category Paths
  const categories = [...new Set(products.map((product) => product.data.category))];
  const categoryPaths = categories.map(category => {
    const filteredProducts = products.filter(p => p.data.category === category);
    return {
      params: { slug: slugify(String(category)) },
      props: { 
        type: 'category' as const, 
        categoryName: category, 
        products: filteredProducts,
        allCategories: categories 
      },
    };
  });

  return [...productPaths, ...categoryPaths];
}

const { type } = Astro.props;
const product = type === 'product' ? Astro.props.product : null;
const categoryName = type === 'category' ? Astro.props.categoryName : null;
const categoryProducts = type === 'category' ? Astro.props.products : null;
const allCategories = type === 'category' ? Astro.props.allCategories : [];

let Content;
if (product) {
  const rendered = await product.render();
  Content = rendered.Content;
}
---

{type === 'product' && product ? (
  <Layout title={`${product.data.title} | Apex Hotel Furniture`} description={product.data.description} image={product.data.images[0]}>
    <div class="bg-gray-50 py-6 border-b">
      <div class="container mx-auto px-6 text-sm breadcrumbs text-gray-500">
        <a href="/" class="hover:text-secondary">Home</a> / 
        <a href="/catalog" class="hover:text-secondary">Catalog</a> / 
        <a href={`/catalog/${slugify(product.data.category)}`} class="hover:text-secondary">{product.data.category}</a> /
        <span class="text-gray-900">{product.data.title}</span>
      </div>
    </div>

    <section class="py-12 bg-white">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
          <!-- Image Gallery -->
          <div class="space-y-4">
            <div class="aspect-w-4 aspect-h-3 rounded-lg overflow-hidden shadow-lg">
              <img src={product.data.images[0]} alt={product.data.title} class="w-full h-full object-cover" id="main-image" />
            </div>
            <div class="grid grid-cols-4 gap-4">
              {product.data.images.map((img) => (
                <button 
                  class="aspect-square rounded-md overflow-hidden border-2 border-transparent hover:border-secondary focus:outline-none transition-all"
                  onclick={`document.getElementById('main-image').src = '${img}'`}
                >
                  <img src={img} alt="Product thumbnail" class="w-full h-full object-cover" />
                </button>
              ))}
            </div>
          </div>

          <!-- Product Info -->
          <div>
            <a href={`/catalog/${slugify(product.data.category)}`} class="text-secondary font-bold uppercase tracking-wider text-sm hover:underline">{product.data.category}</a>
            <h1 class="text-3xl md:text-4xl font-serif font-bold text-primary mt-2 mb-6">{product.data.title}</h1>
            
            <p class="text-gray-600 text-lg mb-8 leading-relaxed">{product.data.description}</p>

            <div class="bg-gray-50 p-6 rounded-lg border mb-8">
              <h3 class="font-bold text-lg mb-4">Product Details</h3>
              <dl class="grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-2">
                {product.data.dimensions && (
                  <div class="sm:col-span-1">
                    <dt class="text-sm font-medium text-gray-500">Dimensions</dt>
                    <dd class="mt-1 text-sm text-gray-900">{product.data.dimensions}</dd>
                  </div>
                )}
                {product.data.moq && (
                  <div class="sm:col-span-1">
                    <dt class="text-sm font-medium text-gray-500">MOQ</dt>
                    <dd class="mt-1 text-sm text-gray-900">{product.data.moq}</dd>
                  </div>
                )}
                {product.data.materials && (
                  <div class="sm:col-span-2">
                    <dt class="text-sm font-medium text-gray-500">Materials</dt>
                    <dd class="mt-1 text-sm text-gray-900">{product.data.materials.join(', ')}</dd>
                  </div>
                )}
              </dl>
            </div>

            <div class="flex gap-4">
              <a href="/contact" class="flex-1 bg-secondary text-white text-center px-8 py-4 text-lg font-bold hover:bg-primary transition-colors shadow-lg">
                Request a Quote
              </a>
              <button class="px-8 py-4 border-2 border-gray-300 text-gray-700 font-bold hover:border-primary hover:text-primary transition-colors">
                Download Spec
              </button>
            </div>
          </div>
        </div>

        <!-- Product Content (Markdown) -->
        <div class="mt-20 prose prose-lg prose-stone max-w-none">
          <Content />
        </div>
      </div>
    </section>
  </Layout>
) : (
  <Layout title={`${categoryName} | Apex Hotel Furniture`} description={`Browse our collection of ${categoryName}.`}>
    <section class="relative py-24 bg-gray-900 flex items-center justify-center overflow-hidden mb-12">
      <div class="absolute inset-0 z-0 opacity-30">
         <img src="https://images.unsplash.com/photo-1616486338812-3dadae4b4f9d?auto=format&fit=crop&w=1920&q=80" alt={categoryName} class="w-full h-full object-cover" />
      </div>
      <div class="relative z-10 text-center max-w-4xl px-6">
        <div class="text-sm breadcrumbs text-gray-300 mb-4 justify-center flex">
          <a href="/" class="hover:text-white">Home</a> <span class="mx-2">/</span> 
          <a href="/catalog" class="hover:text-white">Catalog</a> <span class="mx-2">/</span> 
          <span class="text-white">{categoryName}</span>
        </div>
        <h1 class="text-4xl md:text-5xl font-serif font-bold text-white mb-6">{categoryName}</h1>
      </div>
    </section>

    <div class="container mx-auto px-6 py-12">
      <div class="flex flex-col lg:flex-row gap-12">
        <!-- Sidebar Filters -->
        <aside class="w-full lg:w-1/4">
          <div class="bg-white p-6 shadow-sm rounded-lg border sticky top-24">
            <h3 class="text-xl font-bold mb-4 border-b pb-2">Categories</h3>
            <ul class="space-y-2">
              <li><a href="/catalog" class="text-gray-600 hover:text-secondary transition-colors">All Products</a></li>
              {allCategories.map((cat) => (
                <li>
                  <a 
                    href={`/catalog/${slugify(cat)}`} 
                    class={`transition-colors ${cat === categoryName ? 'text-secondary font-bold' : 'text-gray-600 hover:text-secondary'}`}
                  >
                    {cat}
                  </a>
                </li>
              ))}
            </ul>
             <h3 class="text-xl font-bold mb-4 mt-8 border-b pb-2">By Space</h3>
             <ul class="space-y-2 text-sm text-gray-600">
                <li><a href="#" class="hover:text-secondary">Guest Room</a></li>
                <li><a href="#" class="hover:text-secondary">Lobby & Reception</a></li>
                <li><a href="#" class="hover:text-secondary">Restaurant & Bar</a></li>
                <li><a href="#" class="hover:text-secondary">Outdoor Areas</a></li>
             </ul>
          </div>
        </aside>

        <!-- Product Grid -->
        <main class="w-full lg:w-3/4">
          <ProductGrid products={categoryProducts} />
        </main>
      </div>
    </div>
  </Layout>
)}
